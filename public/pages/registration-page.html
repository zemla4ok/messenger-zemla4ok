<html>

<head>
    <link rel="icon" type="image/png" href="/cat.png" />
    <title>
        Messenger Registration
    </title>
</head>

<body>
    <div id="app"></div>

    <script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.25.0/babel.min.js"></script>
    <script src="/registration-scripts.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script type="text/babel">
            class TextField extends React.Component {
                constructor(props) {
                    super(props);
                    let isValid = this.validate(props.value);
                    this.state = {value: props.value, holder: props.holder, valid: isValid};
                    this.onChange = this.onChange.bind(this);
                }
                validate(val){
                    let expression = new RegExp(/(^)[a-zA-Z]+($)/);
                    return expression.test(val);
                }
                onChange(e) {
                    let val = e.target.value;
                    let isValid = this.validate(val);
                    this.setState({value: val, valid: isValid});
                }
                render() {
                    let color = this.state.valid===true?"green":"red";
                    return <p>
                        <label>{this.state.holder}</label> <br/>
                        <input type="text" placeholder={this.state.holder} value={this.state.value} onChange={this.onChange} style={{borderColor:color}} />
                    </p>;
                }   
            }  

            class PasswordField extends React.Component {
                constructor(props) {
                    super(props);
                    let isValid = this.validate(props.value);
                    this.state = {value: props.value, valid: isValid};
                    this.onChange = this.onChange.bind(this);
                }
                validate(val){
                    let expression = new RegExp(/((?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[@#$%]).{6,20})/);
                    return expression.test(val);                    
                }
                onChange(e) {
                    let val = e.target.value;
                    let isValid = this.validate(val);
                    this.setState({value: val, valid: isValid});
                }
                render() {
                    let color = this.state.valid===true?"green":"red";
                    return <p>
                        <label>Password</label><br/>
                        <input type="password" placeholder="password" id="passField" value={this.state.value} onChange={this.onChange} style={{borderColor:color}} />
                    </p>;
                }  
            }

            class RepeatingPasswordField extends React.Component {
                constructor(props) {
                    super(props);
                    var isValid = false;
                    this.state = {value: props.value, valid: isValid, password: ''};
                    this.onChange = this.onChange.bind(this);
                }
                validate(val){
                    let passField = document.getElementById("passField");
                    return val === passField.value ? true : false;
                }
                onChange(e) {
                    let val = e.target.value;
                    let isValid = this.validate(val);
                    this.setState({value: val, valid: isValid});
                }
                render() {
                    let color = this.state.valid===true?"green":"red";
                    return <p>
                        <label>Repeat password</label><br/>
                        <input type="password" placeholder="repeat password" value={this.state.value} onChange={this.onChange} style={{borderColor:color}} />
                    </p>;
                }  
            }
        
            class UserForm extends React.Component {
                constructor(props) {
                    super(props);
                    this.state = {value: props.value};                    
                    this.handleRegistrate = this.handleRegistrate.bind(this);
                    this.validate = this.validate.bind(this);
                    this.getForm = this.getForm.bind(this);
                }
                getForm(){
                    return {
                        name: this.refs.nameField.state.value,
                        surname: this.refs.surnameField.state.value,
                        login: this.refs.login.state.value,
                        password: this.refs.pass.state.value
                    }
                }
                handleRegistrate() {
                    if(this.validate())
                        alert('non corect data')
                    else{
                        let val = this.getForm();
                        console.log(val);
                        this.setState({value: val});
                        axios.post('http://localhost:3000/registration', this.state.value)
                            .then((response) => {
                                alert('ok');
                                //window.location.replace("http://localhost:3000/login-page.html");
                            })
                            .catch((error) => {
                                alert(error);
                            })
                    }
                }
                validate(){
                    if(this.refs.nameField.state.valid && this.refs.surnameField.state.valid &&
                       this.refs.login.state.valid && 
                       this.refs.pass.state.valid && this.refs.pass2.state.valid)
                        return false;
                    else
                        return true;
                }
            
                render() {
                    return (
                        <form>
                            <TextField value="dima" ref="nameField" holder="Name"/>
                            <TextField value="kot" ref="surnameField" holder="Surname"/>
                            <TextField value="kot" ref="login" holder="Login"/>
                            <PasswordField value="qwQW12!@" ref="pass"/>
                            <RepeatingPasswordField value="qwQW12!@" ref="pass2"/>
                            <input type="button" onClick={this.handleRegistrate} value="registrate" />
                        </form>
                    );
                }
            }
            ReactDOM.render(
                <UserForm />,
                document.getElementById("app")
            )
        </script>
</body>

</html>